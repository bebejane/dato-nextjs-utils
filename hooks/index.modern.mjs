import{useState as e,useEffect as t,useCallback as r,useRef as o}from"react";import{ApolloClient as n,InMemoryCache as i}from"@apollo/client/core/core.cjs";import{BatchHttpLink as a}from"@apollo/client/link/batch-http/batchHttpLink.js";import{useRouter as s}from"next/router.js";function c(){return c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},c.apply(this,arguments)}var l,u;const d="undefined"==typeof window,m=process.env.GRAPHQL_API_ENDPOINT||process.env.NEXT_PUBLIC_GRAPHQL_API_ENDPOINT||"https://graphql.datocms.com",p=process.env.NEXT_PUBLIC_GRAPHQL_API_TOKEN||process.env.GRAPHQL_API_TOKEN,h=null!=(l=null!=(u=process.env.DATOCMS_ENVIRONMENT)?u:process.env.NEXT_PUBLIC_DATOCMS_ENVIRONMENT)?l:"main",v=!!process.env.DATOCMS_INCLUDE_DRAFTS&&"true"===process.env.DATOCMS_INCLUDE_DRAFTS,g={uri:m,fetch:"true"===process.env.LOG_GRAPHQL?async(e,t)=>{const r=t?JSON.parse(t.body.toString()):void 0,o=`${(r?Array.isArray(r)?r.map(e=>e.operationName):[r.operationName]:[]).join(", ")}`,n=await fetch(e,t),i=(new Date).getTime();return c({},n,{async text(){const e=await n.text();return console.log("[33m%s[0m","gql  ",`- ${o}`,`- ${(new Date).getTime()-i}ms`),e}})}:void 0,batchMax:10,batchInterval:50},w=(e=!1,t)=>{const r={Authorization:`Bearer ${t}`,"X-Exclude-Invalid":!0};return(e||v)&&(r["X-Include-Drafts"]=!0),h&&(r["X-Environment"]=h),new a(c({},g,{headers:r}))},f=w(!1,p),y=w(!0,p),E=new n({link:f,cache:new i,ssrMode:d,defaultOptions:{query:{fetchPolicy:process.env.DEV_CACHE?"cache-first":"no-cache",errorPolicy:"all"}}}),A=(o,{variables:n,initialData:i,pageSize:a,preview:s=!1}={})=>{var l,u,d;const[m,h]=e(i),[v,g]=e(i),[A,P]=e(a?{no:1,count:(null==(l=i.pagination)?void 0:l.count)||0,size:a,end:(null==(u=i.pagination)?void 0:u.count)>0&&(null==(d=i.pagination)?void 0:d.count)<=a}:void 0),[N,b]=e(),[O,T]=e(!1);t(()=>{JSON.stringify(i)!==JSON.stringify(m)&&(g(i),h(i))},[i]);const I=r(e=>(T(!0),(async(e,t)=>{const{variables:r,preview:o=!1,apiToken:n}=t||{};if(null===e)throw new Error("Invalid query! Query is empty");if(!p&&!n)throw new Error("No graphql api token exists in .env");try{E.setLink(n?w(o,n):o?y:f);const t=(Array.isArray(e)?e:[e]).map((e,t)=>{const o=Array.isArray(r)&&r.length>t-1?r[t]:r||{};return E.query({query:e,variables:o})}),i=await Promise.all(t),a=[];if(i.filter(({errors:e})=>e).forEach(({errors:e})=>{e.map(e=>e.message).forEach(e=>a.push(e))}),a.length)throw new Error(a.join(". "));let s={};return i.forEach(e=>s=c({},s,null==e?void 0:e.data)),s}catch(e){throw e}})(o,{variables:c({},n,e),preview:s}).then(e=>{const t=S(e,v);return g(t),t}).finally(()=>T(!1))),[o,n,v]),_=r(async()=>{if(!A)return b(new Error("No page size set!"));const e=A.size,t=A.no*A.size;if(t>A.count&&A.count>0)return A;try{var r;const o=await I(c({},n.variables,{first:e,skip:t})),i=(null==(r=o[Object.keys(o).find(e=>!isNaN(o[e].count))])?void 0:r.count)||0,s=A.no+1,l=c({},A,{no:s,count:i,end:s*a>=i});return P(l),l}catch(e){return b(e),A}},[A,n,a,P,b,I]),S=(e,t)=>t&&e?(Object.keys(e).forEach(r=>{t[r]&&Array.isArray(t[r])&&(e[r]=t[r].concat(e[r]))}),e):e;return t(()=>{!i&&I()},[i,I]),{data:v,error:N,loading:O,loadMore:e=>I(e),nextPage:_,page:A}},P=()=>{const r=globalThis.localStorage,o=s(),[n,i]=e(void 0!==r?r.getItem("previousRoute"):null);return t(()=>{const e=r.getItem("currentRoute")||null;e!==o.asPath&&(r.setItem("previousRoute",e),r.setItem("currentRoute",o.asPath),i(e))},[o.asPath,r]),t(()=>{const e=()=>{r.removeItem("previousRoute"),r.removeItem("currentRoute")};return window.addEventListener("unload",e),()=>window.removeEventListener("unload",e)},[]),n};function N(n=0){const i="undefined"==typeof window,[a,s]=e({isScrolling:!1,isPageTop:!1,isPageBottom:!1,isScrolledUp:!0,isScrolledDown:!1,scrolledPosition:i?0:window.pageYOffset,documentHeight:i?0:document.documentElement.offsetHeight,viewportHeight:i?0:window.innerHeight,timer:null}),l=o(a),u=r(()=>{clearTimeout(l.current.timer);const e=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),t=i?0:window.innerHeight,r=i?0:Math.max(0,Math.ceil(window.pageYOffset)),o=!i&&window.innerHeight+r>=e-n,a={isScrolling:!0,isPageTop:!!i||window.pageYOffset<=0,isPageBottom:o,isScrolledUp:r<l.current.scrolledPosition,isScrolledDown:r>l.current.scrolledPosition,scrolledPosition:r,documentHeight:e,viewportHeight:t,timer:l.current.timer};s(a),l.current=c({},a,{timer:setTimeout(()=>s(c({},a,{isScrolling:!1})),100)})},[i,n]);return t(()=>(u(),window.addEventListener("scroll",u),()=>{window.removeEventListener("scroll",u)}),[u]),a}const b=()=>t(()=>{Array.from(document.querySelectorAll('head > link[rel="stylesheet"][data-n-p]')).forEach(e=>{e.removeAttribute("data-n-p")});const e=new MutationObserver(e=>{e.forEach(({target:e})=>{"STYLE"===e.nodeName&&"x"===e.getAttribute("media")&&e.removeAttribute("media")})});return e.observe(document.head,{subtree:!0,attributeFilter:["media"]}),()=>{e.disconnect()}},[]);export{A as useApiQuery,P as usePreviousRoute,N as useScrollInfo,b as useTransitionFix};
//# sourceMappingURL=index.modern.mjs.map
