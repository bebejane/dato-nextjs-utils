{"version":3,"file":"hooks.modern.js","sources":["../src/api/index.ts","../src/hooks/useApiQuery.ts","../src/hooks/usePreviousRoute.ts","../src/hooks/useScrollInfo.ts","../src/hooks/useTransitionFix.ts"],"sourcesContent":["import { ApolloClient, InMemoryCache } from '@apollo/client/core/core.cjs';\nimport { BatchHttpLink } from \"@apollo/client/link/batch-http/batchHttpLink.js\"; \nimport { TypedDocumentNode } from '@apollo/client/core/types.js';\nimport { gql } from \"@apollo/client/core/core.cjs\";\n\nexport type ApiQueryOptions = { variables?: any | any[], preview?: boolean}\n\nconst isServer = typeof window === 'undefined';\nconst GRAPHQL_API_ENDPOINT = process.env.GRAPHQL_API_ENDPOINT || process.env.NEXT_PUBLIC_GRAPHQL_API_ENDPOINT || `https://graphql.datocms.com`;\nconst GRAPHQL_API_TOKEN = process.env.NEXT_PUBLIC_GRAPHQL_API_TOKEN\n\nconst loggingFetch = async (input: RequestInfo, init?: RequestInit): Promise<Response>  => {\n  \n  const queries = init ? JSON.parse(init.body.toString()) : undefined;\n  const operations = queries ? Array.isArray(queries) ? queries.map((op : {operationName:string}) => op.operationName) : [queries.operationName] : [];\n  const requestName = `${operations.join(', ')}`\n  const response = await fetch(input, init)\n  const t = new Date().getTime()\n\n  return {\n    ...response,\n    async text () {\n      const result = await response.text()\n      console.log(\"\\x1b[33m%s\\x1b[0m\", 'gql  ', `- ${requestName}`, `- ${new Date().getTime()-t}ms`)\n      return result\n    }\n  }\n}\n\nconst linkConfig = {\n  uri: GRAPHQL_API_ENDPOINT,\n  fetch: process.env.LOG_GRAPHQL ? loggingFetch : undefined,\n  batchMax: 10, \n  batchInterval: 50,\n  headers: { \n    'Authorization': `Bearer ${GRAPHQL_API_TOKEN}`\n  }\n}\n\nconst link = new BatchHttpLink(linkConfig)\nconst previewLink = new BatchHttpLink({...linkConfig, headers:{...linkConfig.headers, 'X-Include-Drafts': true}})\n\nexport const client = new ApolloClient({\n  link,\n  cache: new InMemoryCache(),\n  ssrMode: isServer,\n  defaultOptions: {\n    query: {\n      fetchPolicy: process.env.DEV_CACHE ? 'cache-first' : 'no-cache',\n      errorPolicy: 'all',\n    }\n  }\n});\n\nexport const SEOQuery = (schema: string) : TypedDocumentNode => {\n  const q = \"query GetSEO {seo: \" + schema + \" {id tags: _seoMetaTags {attributes content tag}}}\";\n  return gql(q) as TypedDocumentNode\n}\n\nexport const apiQuery = async (query: TypedDocumentNode | TypedDocumentNode[], options? : ApiQueryOptions) : Promise<any> => {\n  \n  const { variables, preview = false} = options || {}\n\n  if(query === null) \n    throw new Error('Invalid query! Query is empty')\n\n  if(!GRAPHQL_API_TOKEN) \n    throw new Error('No graphql api token exists in .env')\n  \n  try{\n    \n    client.setLink(preview ? previewLink : link)\n\n    const batch = (Array.isArray(query) ? query : [query]).map((q, idx) => {\n      const vars = Array.isArray(variables) && variables.length > idx -1 ? variables[idx] : variables || {}\n      return client.query({query:q, variables:vars})\n    })\n  \n    const data = await Promise.all(batch)\n    \n    const errorMessages:string[] = []\n    data.filter(({errors}) => errors).forEach(({errors}) => {\n      errors.map(e => e.message).forEach((message) => errorMessages.push(message))\n    })\n    \n    if(errorMessages.length)\n      throw new Error(errorMessages.join('. '))\n    \n    let result = {}\n    data.forEach((res) => result = {...result, ...res?.data})\n    return result\n\n  }catch(err){\n    throw err\n  }\n}","import { TypedDocumentNode } from '@apollo/client/core/core.cjs';\nimport { useEffect, useState, useCallback } from \"react\";\nimport { apiQuery } from '../api/index.js';\n\nexport type UseApiQueryProps = {\n  variables?: any,\n  initialData?: any,\n  pageSize?: number\n}\n\nexport type Pagination = {\n  no: number,\n  count: number,\n  size: number,\n  end:boolean\n}\n\nconst useApiQuery = <T>(document : TypedDocumentNode, {variables, initialData, pageSize} : UseApiQueryProps = {} ) => {\n  \n  const [data, setData] = useState<T>(initialData)\n  const [page, setPage] = useState<Pagination | undefined>(pageSize ? {no:1, count:0, size:pageSize, end:false} : undefined)\n  const [error, setError] = useState<Error | undefined>()\n  const [loading, setLoading] = useState(false)\n\n  const loadMore = (vars: any) => load(vars)\n\n  const nextPage = async () => {\n    if(!page) \n      return setError(new Error('No page size set!'))\n\n    const first = page.size\n    const skip = (page.no*page.size)\n    const d = await load({...variables, first, skip})\n\n    const count = d[Object.keys(d).find(k => !isNaN(d[k].count))]?.count || 0;\n    const no = page.no+1\n    const end = no*pageSize >= count\n    const p = { ...page, no, count, end}\n    \n    setPage(p)\n    return p;\n  }\n\n  const mergeData = (newData, oldData) => {\n  \n    if(!oldData) return newData\n  \n    Object.keys(newData).forEach(k => {\n      if(oldData[k] && Array.isArray(oldData[k]))\n        newData[k] = oldData[k].concat(newData[k])\n    })\n  \n    return newData;\n  }\n\n  const load = useCallback((vars?: any) => {\n    \n    setLoading(true)\n    return apiQuery(document, {variables : vars || variables})\n    .then(res => {\n      const d = mergeData(res, data)\n      setData(d)\n      return d\n    })\n    .catch(err => setError(err))\n    .finally(()=> setLoading(false))\n\n  }, [document, variables, data])\n\n\tuseEffect(()=>{\n    if(!initialData)\n      load()\n    else if(initialData.pagination?.count <= pageSize)\n      setPage((page)=>({...page, end:true}))\n\n  }, [initialData, load, setPage, pageSize])\n\n  return {data, error, loading, loadMore, nextPage,  page}\n};\n\nexport default useApiQuery","import { useRouter } from \"next/router.js\";\nimport { useEffect, useState } from \"react\";\n\nconst usePreviousRoute = () => {\n  \n  const storage = globalThis.sessionStorage\n  const router = useRouter()\n  const [prevRoute, setPrevRoute] = useState(typeof storage !== 'undefined' ? storage.getItem('previousRoute') : null)\n\n\tuseEffect(()=>{\n    const prevRoute = storage.getItem('currentRoute');\n    if (prevRoute === router.asPath) return\n    storage.setItem('previousRoute', prevRoute)\n    storage.setItem(\"currentRoute\", router.asPath);\n    setPrevRoute(prevRoute)\n\t}, [router.asPath, storage])\t\n\n  useEffect(()=>{\n    const handleWindowReload = (e) => {\n      storage.removeItem('previousRoute')\n      storage.removeItem(\"currentRoute\")\n    }\n    window.addEventListener('beforeunload', handleWindowReload)\n    return () => window.removeEventListener('beforeunload', handleWindowReload)\n  })\n\n\n  return prevRoute\n};\n\nexport default usePreviousRoute","\nimport { useEffect, useState, useRef, useCallback } from \"react\";\n\nexport type ScrollInfo = {\n  isScrolling: boolean, \n  isPageTop: boolean,\n  isPageBottom: boolean,\n  isScrolledUp: boolean,\n  isScrolledDown: boolean,\n  scrolledPosition: number,\n  documentHeight: number,\n  viewportHeight: number,\n  timer: ReturnType<typeof setTimeout>,\n}\n\nexport default function useScrollInfo(pageBottomLimit = 0) {\n\n  const isServer = typeof window === 'undefined'\n  const [scrollInfo, setScrollInfo] = useState<ScrollInfo>({\n    isScrolling:false, \n    isPageTop: false,\n    isPageBottom: false,\n    isScrolledUp: true,\n    isScrolledDown: false,\n    scrolledPosition: isServer ? 0 : window.pageYOffset,\n    documentHeight: isServer ? 0 : document.documentElement.offsetHeight,\n    viewportHeight: isServer ? 0 : window.innerHeight,\n    timer:null,\n  });\n\n  const lastScrollInfo = useRef(scrollInfo);\n\n  const handleScroll = useCallback(() => {\n    \n    clearTimeout(lastScrollInfo.current.timer)\n\n    const documentHeight = Math.max(\n      document.body.scrollHeight,\n      document.body.offsetHeight,\n      document.documentElement.clientHeight,\n      document.documentElement.scrollHeight,\n      document.documentElement.offsetHeight\n    );\n    const viewportHeight = isServer ? 0 : window.innerHeight\n    const scrolledPosition = isServer ? 0 : Math.max(0, Math.ceil(window.pageYOffset));\n    const isPageBottom = isServer ? false : (window.innerHeight + scrolledPosition) >= documentHeight - pageBottomLimit;\n    const isPageTop = isServer ? true : window.pageYOffset <= 0;\n    const isScrolledUp = scrolledPosition < lastScrollInfo.current.scrolledPosition;\n    const isScrolledDown = scrolledPosition > lastScrollInfo.current.scrolledPosition;\n    const isScrolling = true;\n    const timer = lastScrollInfo.current.timer;\n    const scrollInfo = {\n      isScrolling,\n      isPageTop,\n      isPageBottom,\n      isScrolledUp,\n      isScrolledDown,\n      scrolledPosition,\n      documentHeight,\n      viewportHeight,\n      timer\n    };\n    setScrollInfo(scrollInfo);\n    lastScrollInfo.current = {\n      ...scrollInfo,\n      timer: setTimeout(() => setScrollInfo({...scrollInfo, isScrolling:false}), 100)\n    }\n    \n  }, [isServer, pageBottomLimit]);\n\n  useEffect(() => {\n    window.addEventListener(\"scroll\", handleScroll);\n    return () => {\n      window.removeEventListener(\"scroll\", handleScroll);\n    };\n  }, [handleScroll]);\n\n  return scrollInfo;\n}\n","import { useEffect } from \"react\";\n\nconst useTransitionFix = () => useEffect(() => {\n\tArray.from(\n\t\t\tdocument.querySelectorAll('head > link[rel=\"stylesheet\"][data-n-p]')\n\t).forEach(node => {\n\t\t\tnode.removeAttribute('data-n-p');\n\t});\n\tconst mutationHandler = mutations => {\n\t\t\tmutations.forEach(({ target }) => {\n\t\t\t\t\tif (target.nodeName === 'STYLE') {\n\t\t\t\t\t\t\tif (target.getAttribute('media') === 'x') {\n\t\t\t\t\t\t\t\t\ttarget.removeAttribute('media');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t});\n\t};\n\tconst observer = new MutationObserver(mutationHandler);\n\tobserver.observe(document.head, {\n\t\t\tsubtree: true,\n\t\t\tattributeFilter: ['media'],\n\t});\n\treturn () => {\n\t\t\tobserver.disconnect();\n\t};\n}, []);\n\n\nexport default useTransitionFix"],"names":["isServer","window","GRAPHQL_API_ENDPOINT","process","env","NEXT_PUBLIC_GRAPHQL_API_ENDPOINT","GRAPHQL_API_TOKEN","NEXT_PUBLIC_GRAPHQL_API_TOKEN","linkConfig","uri","fetch","LOG_GRAPHQL","async","input","init","queries","JSON","parse","body","toString","undefined","Array","isArray","map","op","operationName","join","response","t","Date","getTime","result","text","console","log","requestName","batchMax","batchInterval","headers","Authorization","link","BatchHttpLink","previewLink","_extends","client","ApolloClient","cache","InMemoryCache","ssrMode","defaultOptions","query","fetchPolicy","DEV_CACHE","errorPolicy","useApiQuery","document","variables","initialData","pageSize","data","setData","useState","page","setPage","no","count","size","end","error","setError","loading","setLoading","load","useCallback","vars","options","preview","Error","setLink","batch","q","idx","length","Promise","all","filter","errors","forEach","e","message","errorMessages","push","res","err","then","d","newData","oldData","Object","keys","k","concat","catch","finally","useEffect","pagination","_initialData$paginati","loadMore","nextPage","_d$Object$keys$find","first","skip","find","isNaN","p","usePreviousRoute","storage","globalThis","sessionStorage","router","useRouter","prevRoute","setPrevRoute","getItem","asPath","setItem","handleWindowReload","removeItem","addEventListener","removeEventListener","useScrollInfo","pageBottomLimit","scrollInfo","setScrollInfo","isScrolling","isPageTop","isPageBottom","isScrolledUp","isScrolledDown","scrolledPosition","pageYOffset","documentHeight","documentElement","offsetHeight","viewportHeight","innerHeight","timer","lastScrollInfo","useRef","handleScroll","clearTimeout","current","Math","max","scrollHeight","clientHeight","ceil","setTimeout","useTransitionFix","from","querySelectorAll","node","removeAttribute","observer","MutationObserver","mutations","target","nodeName","getAttribute","observe","head","subtree","attributeFilter","disconnect"],"mappings":"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"}