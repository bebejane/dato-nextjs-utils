import{ApolloClient as e,InMemoryCache as t,gql as r}from"@apollo/client/core/core.cjs";import{BatchHttpLink as o}from"@apollo/client/link/batch-http/batchHttpLink.js";import{buildClient as i}from"@datocms/cma-client";import n,{useState as a,useCallback as s,useEffect as l,useRef as c}from"react";import{useRouter as u}from"next/router.js";import{NextSeo as d,DefaultSeo as m}from"next-seo";import p from"react-markdown";import g from"remark-gfm";import h from"next/link.js";import f from"markdown-truncate";import w from"remark-breaks";function v(){return v=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},v.apply(this,arguments)}const y="undefined"==typeof window,b=process.env.GRAPHQL_API_ENDPOINT||process.env.NEXT_PUBLIC_GRAPHQL_API_ENDPOINT||"https://graphql.datocms.com",E=process.env.NEXT_PUBLIC_GRAPHQL_API_TOKEN,A={uri:b,fetch:"true"===process.env.LOG_GRAPHQL?async(e,t)=>{const r=t?JSON.parse(t.body.toString()):void 0,o=`${(r?Array.isArray(r)?r.map(e=>e.operationName):[r.operationName]:[]).join(", ")}`,i=await fetch(e,t),n=(new Date).getTime();return v({},i,{async text(){const e=await i.text();return console.log("[33m%s[0m","gql  ",`- ${o}`,`- ${(new Date).getTime()-n}ms`),e}})}:void 0,batchMax:10,batchInterval:50},S=(e=!1,t=E)=>{const r={Authorization:`Bearer ${t}`,"X-Exclude-Invalid":!0};return e&&(r["X-Include-Drafts"]=!0),new o(v({},A,{headers:r}))},P=S(!1,E),_=S(!0,E),T=new e({link:P,cache:new t,ssrMode:y,defaultOptions:{query:{fetchPolicy:process.env.DEV_CACHE?"cache-first":"no-cache",errorPolicy:"all"}}}),I=async(e,t)=>{const{variables:r,preview:o=!1,apiToken:i}=t||{};if(null===e)throw new Error("Invalid query! Query is empty");if(!E)throw new Error("No graphql api token exists in .env");try{T.setLink(i?S(o,i):o?_:P);const t=(Array.isArray(e)?e:[e]).map((e,t)=>{const o=Array.isArray(r)&&r.length>t-1?r[t]:r||{};return T.query({query:e,variables:o})}),n=await Promise.all(t),a=[];if(n.filter(({errors:e})=>e).forEach(({errors:e})=>{e.map(e=>e.message).forEach(e=>a.push(e))}),a.length)throw new Error(a.join(". "));let s={};return n.forEach(e=>s=v({},s,null==e?void 0:e.data)),s}catch(e){throw e}},k=(e,t)=>r(`query GetSEO{\n    seo: ${e} ( filter: { id: { eq: "${t}" } }) {\n      id \n      tags: _seoMetaTags {\n        attributes \n        content \n        tag\n      }\n    }\n  }`),N=e=>(console.error(e),e.message||e);let H;function x(e,t){const r=parseInt(process.env.REVALIDATE_TIME),o=[L];return e.query&&o.push(e.query),e.queries&&o.push.apply(o,e.queries),e.seo&&o.push(k(e.seo)),async e=>{const i=await I(o,{preview:e.preview});return t?await t({context:e,props:v({},i),revalidate:r}):{props:v({},i),context:e,revalidate:r}}}const L=r(H||(H=(e=>e)`
  query Global {
    site: _site {
      favicon: faviconMetaTags {
      attributes
      content
      tag
    }
    globalSeo {
      facebookPageUrl
      siteName
      titleSuffix
      twitterAccount
      fallbackSeo {
        description
        title
        twitterCard
        image {
          id
          title
          width
          responsiveImage {
            alt
            aspectRatio
            base64
            bgColor
            height
            sizes
            src
            srcSet
            webpSrcSet
            title
            width
          }
        }
      }
    }
  }
}
`));async function q(e,t){if(e.query.secret!==process.env.DATOCMS_PREVIEW_SECRET||!e.query.slug)return t.status(401).json({message:"Invalid token"});const{slug:r}=e.query;try{t.setPreviewData({},{maxAge:10}),t.writeHead(307,{Location:r||"/"}),t.end()}catch(e){return console.error(e),t.status(401).json({message:"Error previewing page!"})}}function O(e){return async(t,r)=>{var o;if(!(e=>{const t=e.headers.authorization;if(!t)return!0;const r=t.split(" ")[1],[o,i]=Buffer.from(r,"base64").toString().split(":");return o===process.env.BASIC_AUTH_USER&&i===process.env.BASIC_AUTH_PASSWORD})(t))return r.status(401).send("Access denied");const n=null==(o=t.body)?void 0:o.entity;if(!n)throw"Payload is empty";const a=await(async e=>{var t,r,o;const n=null==e||null==(t=e.relationships)||null==(r=t.item_type)||null==(o=r.data)?void 0:o.id;if(!n)throw"Model id not found in payload!";console.log("resolve modelId",n);const a=i({apiToken:process.env.NEXT_PUBLIC_GRAPHQL_API_TOKEN,requestTimeout:3e3}),s=(await a.itemTypes.list()).find(e=>e.id===n),l=(await a.items.list({filter:{type:s.api_key,fields:{id:{eq:e.id}}}}))[0];if(!l)throw`No record found with modelId: ${n}`;return console.log("revalidate",s.api_key),v({},l,{model:s})})(n);e(a,async e=>{try{if(!e.length)throw"Nothing to revalidate";return console.log("revalidating paths",e),await Promise.all(e.map(e=>r.revalidate(e))),console.log("revalidating done!"),r.json({revalidated:!0,paths:e})}catch(e){return console.error(e),r.json({revalidated:!1,err:e})}})}}const R=(e,{variables:t,initialData:r,pageSize:o}={})=>{var i,n;console.log("useApiQuery");const[c,u]=a(r),[d,m]=a(o?{no:1,count:0,size:o,end:(null==(i=r.pagination)?void 0:i.count)>0&&(null==(n=r.pagination)?void 0:n.count)<=o}:void 0),[p,g]=a(),[h,f]=a(!1),w=s(r=>(f(!0),I(e,{variables:r||t}).then(e=>{const t=(r=e,(o=c)?(Object.keys(r).forEach(e=>{o[e]&&Array.isArray(o[e])&&(r[e]=o[e].concat(r[e]))}),r):r);var r,o;return u(t),t}).catch(e=>g(e)).finally(()=>f(!1))),[e,t,c]);return l(()=>{!r&&w()},[r,w]),{data:c,error:p,loading:h,loadMore:e=>w(e),nextPage:async()=>{var e;if(!d)return g(new Error("No page size set!"));const r=d.size,i=d.no*d.size,n=await w(v({},t,{first:r,skip:i})),a=(null==(e=n[Object.keys(n).find(e=>!isNaN(n[e].count))])?void 0:e.count)||0,s=d.no+1,l=v({},d,{no:s,count:a,end:s*o>=a});return m(l),l},page:d}},$=()=>{const e=globalThis.sessionStorage,t=u(),[r,o]=a(void 0!==e?e.getItem("previousRoute"):null);return l(()=>{const r=e.getItem("currentRoute");r!==t.asPath&&(e.setItem("previousRoute",r),e.setItem("currentRoute",t.asPath),o(r))},[t.asPath,e]),l(()=>{const t=t=>{e.removeItem("previousRoute"),e.removeItem("currentRoute")};return window.addEventListener("beforeunload",t),()=>window.removeEventListener("beforeunload",t)}),r};function j(e=0){const t="undefined"==typeof window,[r,o]=a({isScrolling:!1,isPageTop:!1,isPageBottom:!1,isScrolledUp:!0,isScrolledDown:!1,scrolledPosition:t?0:window.pageYOffset,documentHeight:t?0:document.documentElement.offsetHeight,viewportHeight:t?0:window.innerHeight,timer:null}),i=c(r),n=s(()=>{clearTimeout(i.current.timer);const r=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),n=t?0:window.innerHeight,a=t?0:Math.max(0,Math.ceil(window.pageYOffset)),s=!t&&window.innerHeight+a>=r-e,l={isScrolling:!0,isPageTop:!!t||window.pageYOffset<=0,isPageBottom:s,isScrolledUp:a<i.current.scrolledPosition,isScrolledDown:a>i.current.scrolledPosition,scrolledPosition:a,documentHeight:r,viewportHeight:n,timer:i.current.timer};o(l),i.current=v({},l,{timer:setTimeout(()=>o(v({},l,{isScrolling:!1})),100)})},[t,e]);return l(()=>(window.addEventListener("scroll",n),()=>{window.removeEventListener("scroll",n)}),[n]),r}const C=()=>l(()=>{Array.from(document.querySelectorAll('head > link[rel="stylesheet"][data-n-p]')).forEach(e=>{e.removeAttribute("data-n-p")});const e=new MutationObserver(e=>{e.forEach(({target:e})=>{"STYLE"===e.nodeName&&"x"===e.getAttribute("media")&&e.removeAttribute("media")})});return e.observe(document.head,{subtree:!0,attributeFilter:["media"]}),()=>{e.disconnect()}},[]),D=({seo:e={},site:t={},pathname:r,title:o,subtitle:i,description:a,noindex:s=!1})=>{const l=B({seo:e,site:t,pathname:r}),{globalSeo:c,favicon:u}=t,m=u?u.map(({attributes:e})=>v({},e)):[],p=U(l["og:image"],l["og:image:width"],l["og:image:height"]),g=`${process.env.NEXT_PUBLIC_SITE_URL}${r||""}`;return o||(c&&(o=c.siteName),(null!=c&&c.titleSuffix||i)&&(o=`${o}${null!=c&&c.titleSuffix?` ${null==c?void 0:c.titleSuffix}`:""}${i?` ${i}`:""}`)),a||(a=l.description?l.description:c?null==c?void 0:c.fallbackSeo.description:void 0),/*#__PURE__*/n.createElement(d,{title:o,description:a,canonical:g,openGraph:{url:g,title:o,description:a,images:p,locale:l["og:locale"],type:l["og:type"],site_name:l["og:site_name"]},twitter:{title:o,image:l["og:image"],handle:null==c?void 0:c.twitterAccount,site:null==c?void 0:c.twitterAccount,cardType:"summary_large_image"},additionalLinkTags:m,noindex:s,nofollow:s})},M=({site:e,title:t,description:r})=>{const{globalSeo:o,favicon:i,globalSeo:{fallbackSeo:a}}=e,s=i?i.map(({attributes:e})=>v({},e)):[],l=o.twitterAccount?`https://twitter.com/${o.twitterAccount.replace("@","")}`:void 0;/*#__PURE__*/return n.createElement(m,{title:t,description:r,additionalLinkTags:s,openGraph:{type:"website",locale:o.locale,site_name:o.siteName},twitter:{handle:o.twitterAccount,site:l,cardType:a.twitterCard}})},U=(e,t,r)=>{if(e)return e.split("?"),[{url:e,width:t,height:r}]},B=({seo:e,site:t,pathname:r})=>{if(!e||!t)return[];const{globalSeo:o}=t||{},{fallbackSeo:i}=o||{};let n=(Array.isArray(e)?e:e.tags)||[],a=n.filter(e=>"title"===e.tag)[0];a&&o&&("/"===r?a=v({},a,{content:o.siteName}):o&&a.content.startsWith(o.siteName)&&(a=v({},a,{content:`${o.siteName} â€“ ${a.content}`}))),n=n.map(e=>"title"!==e.tag?e:a);const s={};if(n.forEach(e=>{s[e.attributes?e.attributes.property||e.attributes.name:e.tag]=e.attributes?e.attributes.content||e.attributes:e.content}),!s["og:image"]&&null!=i&&i.image){const e=1e3,t=1-(i.image.width-e)/i.image.width;s["og:image"]=`${i.image.url}?w=1000`,s["og:image:width"]=e,s["og:image:height"]=Math.round(i.image.height*t)}return s},G=({children:e,truncate:t,className:r,sentances:o})=>{if(!e)return null;const i=t?f(e,{limit:t,ellipsis:!0}):o?((e,t)=>{if(!e)return e;const r=e.split(".");return r.length>=t?r.slice(0,t).join(" ")+"...":e})(e,o):e;/*#__PURE__*/return n.createElement(p,{remarkPlugins:[g,w],className:r,children:i,components:{a:({children:e,href:t})=>/*#__PURE__*/n.createElement(h,{scroll:!1,href:t},/*#__PURE__*/n.createElement("a",null,e[0]))}})};export{G as DatoMarkdown,D as DatoSEO,M as DefaultDatoSEO,k as SEOQuery,I as apiQuery,T as client,N as datoError,R as useApiQuery,$ as usePreviousRoute,j as useScrollInfo,C as useTransitionFix,x as withGlobalProps,q as withPreview,O as withRevalidate};
//# sourceMappingURL=index.modern.mjs.map
